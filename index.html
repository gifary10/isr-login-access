<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Bagian head tidak diubah -->
    <!-- ... -->
</head>
<body>
    <!-- Bagian HTML tidak diubah -->
    <!-- ... -->

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBp1bZZk7S11oIo6jBQKj1jjP78OXgqPa4",
            authDomain: "isr-project-3dc62.firebaseapp.com",
            projectId: "isr-project-3dc62",
            storageBucket: "isr-project-3dc62.appspot.com",
            messagingSenderId: "549792110057",
            appId: "1:549792110057:web:b8e36a02549cd48753e778"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        
        // Google Sheets API endpoint
        const SHEET_ID = "1e0-Z7QEPITaeVz2PR41Cj4Sujyjtrcxxo9PpqAmYrWo";
        const SHEET_NAME = "master";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwKEQXnVbatJTBuVky_JEYKxuTRfhtocfQ5RSYE7EwGBDoZcqbZuCEM_E8IGyobzMC2tQ/exec";
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const sections = document.querySelectorAll('.form-section');
            const verifyBtn = document.getElementById('verifyBtn');
            const verifyBtnText = document.getElementById('verifyBtnText');
            const verifyBtnSpinner = document.getElementById('verifyBtnSpinner');
            const backBtn1 = document.getElementById('backBtn1');
            const backBtn2 = document.getElementById('backBtn2');
            const submitCode = document.getElementById('submitCode');
            const productSelect = document.getElementById('product');
            const productTitle = document.getElementById('productTitle');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const emailInput = document.getElementById('email');
            const loadingSpinner = document.getElementById('loadingSpinner');
            let currentEmail = "";
            let userProducts = [];
            let expectedAccessCode = "";
            let redirectUrl = "";
            
            // Switch between sections
            function showSection(sectionId) {
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
            }
            
            // Enable Google sign-in button when email is valid
            emailInput.addEventListener('input', function() {
                const isValidEmail = this.value.includes('@');
                this.classList.remove('is-invalid');
            });
            
            // Google sign-in handler
            googleSignInBtn.addEventListener('click', function() {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        const user = result.user;
                        emailInput.value = user.email;
                        verifyEmail(user.email);
                    })
                    .catch((error) => {
                        console.error('Google sign-in error:', error);
                        alert('Error signing in with Google');
                    });
            });
            
            // Verify email function
            function verifyEmail(email) {
                if (!email.includes('@')) {
                    emailInput.classList.add('is-invalid');
                    return;
                }
                
                // Show loading state
                verifyBtnText.textContent = 'Verifying...';
                verifyBtnSpinner.classList.remove('d-none');
                verifyBtn.disabled = true;
                
                // Check email in Google Sheet
                fetch(`${SCRIPT_URL}?action=verifyEmail&email=${encodeURIComponent(email)}`)
                    .then(response => response.json())
                    .then(data => {
                        verifyBtnText.textContent = 'Continue';
                        verifyBtnSpinner.classList.add('d-none');
                        verifyBtn.disabled = false;
                        
                        if (data.success) {
                            currentEmail = email;
                            document.getElementById('userEmail').textContent = email;
                            
                            // Populate products dropdown
                            productSelect.innerHTML = '<option selected disabled>Select a product</option>';
                            data.products.forEach(product => {
                                const option = document.createElement('option');
                                option.value = product;
                                option.textContent = product;
                                productSelect.appendChild(option);
                            });
                            
                            showSection('productSection');
                        } else {
                            emailInput.classList.add('is-invalid');
                            alert('Email not found in our system');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        verifyBtnText.textContent = 'Continue';
                        verifyBtnSpinner.classList.add('d-none');
                        verifyBtn.disabled = false;
                        alert('Error verifying email');
                    });
            }
            
            // Verify email button
            verifyBtn.addEventListener('click', function() {
                verifyEmail(emailInput.value);
            });
            
            // Back to email
            backBtn1.addEventListener('click', () => showSection('emailSection'));
            
            // Product selected
            productSelect.addEventListener('change', function() {
                if (this.value) {
                    productTitle.textContent = this.value;
                    
                    // Get access code for selected product
                    fetch(`${SCRIPT_URL}?action=getAccessCode&email=${encodeURIComponent(currentEmail)}&product=${encodeURIComponent(this.value)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                expectedAccessCode = data.accessCode;
                                redirectUrl = data.redirectUrl;
                                showSection('accessCodeSection');
                            } else {
                                alert('Error getting product information');
                                this.value = '';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error getting product information');
                            this.value = '';
                        });
                }
            });
            
            // Back to product
            backBtn2.addEventListener('click', () => showSection('productSection'));
            
            // Submit access code
            submitCode.addEventListener('click', function() {
                const accessCode = document.getElementById('accessCode').value;
                
                if (!accessCode || accessCode !== expectedAccessCode) {
                    document.getElementById('accessCode').classList.add('is-invalid', 'shake');
                    setTimeout(() => document.getElementById('accessCode').classList.remove('shake'), 500);
                    return;
                }
                
                // Show loading spinner and hide form
                sections.forEach(section => section.classList.remove('active'));
                loadingSpinner.style.display = 'block';
                
                // Redirect to the target URL
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 2000);
            });
            
            // Clear validation on input
            document.getElementById('accessCode').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
        });
    </script>
</body>
</html>

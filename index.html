<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verifikasi User</title>
<style>
body { font-family:sans-serif; margin:20px; }
section { margin-bottom:20px; padding:15px; border:1px solid #ccc; border-radius:8px; }
label { display:block; margin-top:10px; }
input, select, button { margin-top:5px; padding:5px; width:200px; }
button { width:auto; cursor:pointer; }
#verifyResult { color:red; }
</style>
</head>
<body>

<h1>Verifikasi User</h1>

<section id="section1">
  <h2>Step 1: Verifikasi User</h2>
  <label>User:</label><input type="text" id="inputUser">
  <label>Email:</label><input type="email" id="inputEmail">
  <br><button id="btnVerify">Verifikasi</button>
  <p id="verifyResult"></p>
</section>

<section id="section2" style="display:none;">
  <h2>Step 2: Pilih Produk</h2>
  <select id="selectProduk"></select>
</section>

<section id="section3" style="display:none;">
  <h2>Step 3: Masukkan Kode Akses</h2>
  <label>Kode Akses:</label><input type="text" id="inputKode">
  <br><button id="btnSubmitKode">Submit</button>
  <p id="kodeResult" style="color:red;"></p>
</section>

<script>
const JSON_URL = "https://script.google.com/macros/s/AKfycbyALe5PeEF2jQxjsBEU588RSErJliUmFh3SJrS__kIgPWVoWjWN4DPG9hBMDJjLjji8fg/exec"; // ganti

let matchedRows = [];

function getQueryParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

// ===== Inisialisasi halaman =====
(async function init() {
  const token = getQueryParam("token");
  if(token) {
    try {
      const res = await fetch(`${JSON_URL}?token=${token}`);
      const data = await res.json();
      if(data.valid) {
        // Ambil semua data JSON
        const allDataRes = await fetch(JSON_URL);
        const allData = await allDataRes.json();
        const matched = allData.find(row => row["Kode Akses"] === data.kode);
        if(matched && matched.Link) {
          window.location.href = matched.Link + "?token=" + token;
          return;
        }
      }
    } catch(err) { console.error(err); }
  }
  // Token invalid â†’ tampilkan form
  document.getElementById('section1').style.display = "block";
})();

// Step 1: verifikasi manual
document.getElementById('btnVerify').addEventListener('click', async () => {
  const user = document.getElementById('inputUser').value.trim();
  const email = document.getElementById('inputEmail').value.trim();
  document.getElementById('verifyResult').textContent = "";
  if(!user || !email) { document.getElementById('verifyResult').textContent="User/Email harus diisi!"; return; }

  try {
    const res = await fetch(JSON_URL);
    const data = await res.json();
    matchedRows = data.filter(row => row.User.toLowerCase()===user.toLowerCase() && row.Email.toLowerCase()===email.toLowerCase());
    if(matchedRows.length>0) {
      document.getElementById('verifyResult').textContent = "User ditemukan!";
      populateProduk(matchedRows);
    } else {
      document.getElementById('verifyResult').textContent = "User/Email tidak ditemukan.";
    }
  } catch(err) { console.error(err); document.getElementById('verifyResult').textContent="Gagal mengambil data."; }
});

function populateProduk(rows) {
  const select = document.getElementById('selectProduk');
  select.innerHTML = "";
  rows.forEach(row => {
    const option = document.createElement('option');
    option.value = row.Produk; option.textContent = row.Produk;
    select.appendChild(option);
  });
  document.getElementById('section2').style.display = "block";
  document.getElementById('section3').style.display = "block";
}

// Step 3: submit kode
document.getElementById('btnSubmitKode').addEventListener('click', () => {
  const selectedProduk = document.getElementById('selectProduk').value;
  const inputKode = document.getElementById('inputKode').value.trim();
  const kodeResult = document.getElementById('kodeResult'); kodeResult.textContent="";
  const matched = matchedRows.find(row => row.Produk===selectedProduk && row["Kode Akses"]===inputKode);
  if(matched) {
    if(matched.Link) window.location.href = matched.Link + "?token=" + inputKode;
    else kodeResult.textContent = "Link tidak tersedia.";
  } else kodeResult.textContent = "Kode akses salah!";
});
</script>

</body>
</html>



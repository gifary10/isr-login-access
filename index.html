<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi User</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; padding: 20px; }
        .card { border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: none; }
        .card-header { background-color: #4a6baf; color: white; border-radius: 10px 10px 0 0 !important; padding: 15px 20px; }
        .btn-primary { background-color: #4a6baf; border-color: #4a6baf; padding: 8px 20px; margin-top: 15px; }
        .btn-primary:hover { background-color: #3a5a9f; border-color: #3a5a9f; }
        .form-control, .form-select { border-radius: 5px; padding: 10px; margin-top: 8px; }
        .form-label { font-weight: 500; margin-top: 15px; }
        .icon { vertical-align: middle; margin-right: 8px; }
        .result-message { margin-top: 15px; padding: 10px; border-radius: 5px; }
        .success-message { color: #155724; background-color: #d4edda; }
        .error-message { color: #721c24; background-color: #f8d7da; }
    </style>
</head>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="text-center mb-4">
                <span class="material-icons icon" style="font-size: 36px;">verified_user</span>
                Verifikasi User
            </h1>

            <div class="card">
                <div class="card-header">
                    <h2 class="h5 mb-0">
                        <span class="material-icons icon">assignment</span>
                        Form Verifikasi 3 Langkah
                    </h2>
                </div>
                <div class="card-body">

                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="progress" style="height: 20px; border-radius: 10px;">
                            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 33%;" aria-valuenow="1" aria-valuemin="0" aria-valuemax="3">
                                Step 1 dari 3
                            </div>
                        </div>
                    </div>

                    <!-- Step 1 -->
                    <div id="section1">
                        <h5 class="mb-3"><span class="material-icons icon">how_to_reg</span>Step 1: Verifikasi User</h5>
                        <div class="mb-3">
                            <label for="inputUser" class="form-label"><span class="material-icons icon">person</span>User</label>
                            <input type="text" class="form-control" id="inputUser" placeholder="Masukkan nama user">
                        </div>
                        <div class="mb-3">
                            <label for="inputEmail" class="form-label"><span class="material-icons icon">email</span>Email</label>
                            <input type="email" class="form-control" id="inputEmail" placeholder="Masukkan email">
                        </div>
                        <button id="btnVerify" class="btn btn-primary"><span class="material-icons icon">check_circle</span>Verifikasi</button>
                        <div id="verifyResult" class="result-message"></div>
                        <hr>
                    </div>

                    <!-- Step 2 -->
                    <div id="section2" style="display:none;">
                        <h5 class="mb-3"><span class="material-icons icon">shopping_cart</span>Step 2: Pilih Produk</h5>
                        <div class="mb-3">
                            <label for="selectProduk" class="form-label"><span class="material-icons icon">category</span>Produk</label>
                            <select id="selectProduk" class="form-select"></select>
                        </div>
                        <button id="btnNextStep2" class="btn btn-primary"><span class="material-icons icon">arrow_forward</span>Lanjut</button>
                        <hr>
                    </div>

                    <!-- Step 3 -->
                    <div id="section3" style="display:none;">
                        <h5 class="mb-3"><span class="material-icons icon">vpn_key</span>Step 3: Masukkan Kode Akses</h5>
                        <div class="mb-3">
                            <label for="inputKode" class="form-label"><span class="material-icons icon">lock</span>Kode Akses</label>
                            <input type="text" class="form-control" id="inputKode" placeholder="Masukkan kode akses">
                        </div>
                        <button id="btnSubmitKode" class="btn btn-primary"><span class="material-icons icon">send</span>Submit</button>
                        <div id="kodeResult" class="result-message"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
const JSON_URL = "https://script.google.com/macros/s/AKfycbxmmdgHsgikOoJ_H5ppkFLSKIZfwmgQbcl2xMjon3naP-c-Oqf8t-q2X80tuvtYM-MF5w/exec";
let matchedRows = [];

function updateProgress(step) {
    const progressBar = document.getElementById("progressBar");
    let percent = step * 33.33;
    progressBar.style.width = percent + "%";
    progressBar.setAttribute("aria-valuenow", step);
    progressBar.textContent = "Step " + step + " dari 3";
}

// Step 1 → Verifikasi User
document.getElementById('btnVerify').addEventListener('click', async () => {
    const user = document.getElementById('inputUser').value.trim();
    const email = document.getElementById('inputEmail').value.trim();
    const verifyResult = document.getElementById('verifyResult');
    verifyResult.textContent = "";
    verifyResult.className = "result-message";
    
    if(!user || !email) { 
        verifyResult.textContent = "User/Email harus diisi!";
        verifyResult.className = "result-message error-message";
        return; 
    }

    try {
        const res = await fetch(JSON_URL);
        const data = await res.json();
        matchedRows = data.filter(row => row.User.toLowerCase()===user.toLowerCase() && row.Email.toLowerCase()===email.toLowerCase());
        
        if(matchedRows.length>0) {
            verifyResult.textContent = "User ditemukan!";
            verifyResult.className = "result-message success-message";
            populateProduk(matchedRows);
            document.getElementById('section1').style.display = "none";
            document.getElementById('section2').style.display = "block";
            updateProgress(2);
        } else {
            verifyResult.textContent = "User/Email tidak ditemukan.";
            verifyResult.className = "result-message error-message";
        }
    } catch(err) { 
        console.error(err); 
        verifyResult.textContent = "Gagal mengambil data.";
        verifyResult.className = "result-message error-message";
    }
});

// Isi dropdown produk
function populateProduk(rows) {
    const select = document.getElementById('selectProduk');
    select.innerHTML = "";
    rows.forEach(row => {
        const option = document.createElement('option');
        option.value = row.Produk; 
        option.textContent = row.Produk;
        select.appendChild(option);
    });
}

// Step 2 → Lanjut ke Step 3
document.getElementById('btnNextStep2').addEventListener('click', () => {
    if(!document.getElementById('selectProduk').value){
        alert("Silakan pilih produk terlebih dahulu");
        return;
    }
    document.getElementById('section2').style.display = "none";
    document.getElementById('section3').style.display = "block";
    updateProgress(3);
});

// Step 3 → Submit kode akses
document.getElementById('btnSubmitKode').addEventListener('click', () => {
    const selectedProduk = document.getElementById('selectProduk').value;
    const inputKode = document.getElementById('inputKode').value.trim();
    const kodeResult = document.getElementById('kodeResult');
    kodeResult.textContent = "";
    kodeResult.className = "result-message";
    
    const matched = matchedRows.find(row => row.Produk===selectedProduk && row["Kode Akses"]===inputKode);
    if(matched) {
        if(matched.Link) {
            window.location.href = matched.Link + "?token=" + inputKode;
        } else {
            kodeResult.textContent = "Link tidak tersedia.";
            kodeResult.className = "result-message error-message";
        }
    } else {
        kodeResult.textContent = "Kode akses salah!";
        kodeResult.className = "result-message error-message";
    }
});
</script>
</body>
</html>
